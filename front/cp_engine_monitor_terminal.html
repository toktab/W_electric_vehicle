<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CP Engine & Monitor - Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <style>
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.3); } 50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.6); } }
        .terminal-cursor { animation: blink 1s step-end infinite; }
        .terminal-output { font-family: 'JetBrains Mono', monospace; white-space: pre-wrap; }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* ANSI Color Support */
        .ansi-white { color: #ffffff; }
        .ansi-green { color: #10b981; }
        .ansi-red { color: #ef4444; }
        .ansi-blue { color: #3b82f6; }
        .ansi-yellow { color: #f59e0b; }
        .ansi-cyan { color: #06b6d4; }
        .ansi-purple { color: #a855f7; }
    </style>
</head>
<body class="bg-neutral-950 text-neutral-100 h-screen overflow-hidden flex flex-col" style="font-family: 'Inter', sans-serif;">
    
    <div class="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8 py-6 flex-1 flex flex-col min-h-0">
        
        <!-- Header -->
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3 group">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center pulse-glow transition-transform group-hover:scale-110">
                    <span class="iconify text-white" data-icon="lucide:zap" data-width="22" data-height="22"></span>
                </div>
                <div>
                    <span class="text-xl font-bold tracking-tight bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent" id="header-title">CP-??? Terminal</span>
                    <p class="text-xs text-neutral-500">Live Engine & Monitor</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 glass rounded-full px-4 py-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full" id="engine-status"></div>
                    <span class="text-xs text-neutral-400">Engine</span>
                </div>
                <div class="flex items-center gap-2 glass rounded-full px-4 py-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full" id="monitor-status"></div>
                    <span class="text-xs text-neutral-400">Monitor</span>
                </div>
                <a href="index.html" class="glass rounded-full px-4 py-2 hover:bg-white/10 transition-all hover:scale-105 active:scale-95 flex items-center gap-2">
                    <span class="iconify text-emerald-400" data-icon="lucide:home" data-width="18" data-height="18"></span>
                    <span class="text-sm font-medium hidden sm:inline">Dashboard</span>
                </a>
            </div>
        </header>

        <!-- Dual Terminal Windows -->
        <div class="grid lg:grid-cols-2 gap-6 flex-1 min-h-0">
            
            <!-- Engine Terminal -->
            <div class="glass rounded-2xl flex flex-col min-h-0">
                <div class="bg-neutral-900 px-4 py-2 flex items-center justify-between border-b border-neutral-800">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-500/80"></div>
                            <div class="w-3 h-3 rounded-full bg-amber-500/80"></div>
                            <div class="w-3 h-3 rounded-full bg-emerald-500/80"></div>
                        </div>
                        <span class="text-xs text-neutral-500 ml-2" id="engine-container-name">Engine Terminal</span>
                    </div>
                    <button onclick="clearTerminal('engine')" class="text-xs text-neutral-500 hover:text-neutral-300 transition">
                        <span class="iconify" data-icon="lucide:trash-2" data-width="14" data-height="14"></span>
                    </button>
                </div>
                
                <div id="engine-output" class="terminal-output text-sm p-4 flex-1 min-h-0 overflow-y-auto bg-neutral-950 text-emerald-400">
                    <div class="text-neutral-500">Connecting to Engine...</div>
                </div>
                
                <div class="bg-neutral-900 border-t border-neutral-800 p-3 flex items-center gap-2">
                    <span class="text-emerald-400 text-sm terminal-output">engine$</span>
                    <input 
                        type="text" 
                        id="engine-input" 
                        class="flex-1 bg-transparent text-emerald-400 text-sm outline-none terminal-output"
                        placeholder="Type command..."
                        autocomplete="off"
                        onkeypress="handleInput(event, 'engine')"
                        disabled
                    >
                    <span class="terminal-cursor text-emerald-400 text-sm">▊</span>
                </div>
            </div>

            <!-- Monitor Terminal -->
            <div class="glass rounded-2xl flex flex-col min-h-0">
                <div class="bg-neutral-900 px-4 py-2 flex items-center justify-between border-b border-neutral-800">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-500/80"></div>
                            <div class="w-3 h-3 rounded-full bg-amber-500/80"></div>
                            <div class="w-3 h-3 rounded-full bg-emerald-500/80"></div>
                        </div>
                        <span class="text-xs text-neutral-500 ml-2" id="monitor-container-name">Monitor Terminal</span>
                    </div>
                    <button onclick="clearTerminal('monitor')" class="text-xs text-neutral-500 hover:text-neutral-300 transition">
                        <span class="iconify" data-icon="lucide:trash-2" data-width="14" data-height="14"></span>
                    </button>
                </div>
                
                <div id="monitor-output" class="terminal-output text-sm p-4 flex-1 min-h-0 overflow-y-auto bg-neutral-950 text-cyan-400">
                    <div class="text-neutral-500">Connecting to Monitor...</div>
                </div>
                
                <div class="bg-neutral-900 border-t border-neutral-800 p-3 flex items-center gap-2">
                    <span class="text-cyan-400 text-sm terminal-output">monitor$</span>
                    <input 
                        type="text" 
                        id="monitor-input" 
                        class="flex-1 bg-transparent text-cyan-400 text-sm outline-none terminal-output"
                        placeholder="Type command..."
                        autocomplete="off"
                        onkeypress="handleInput(event, 'monitor')"
                        disabled
                    >
                    <span class="terminal-cursor text-cyan-400 text-sm">▊</span>
                </div>
            </div>

        </div>

    </div>

    <script>
        let engineWs = null;
        let monitorWs = null;
        let cpNum = null;

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        cpNum = urlParams.get('cp') || '1';

        // Update header
        document.getElementById('header-title').textContent = `CP-${String(cpNum).padStart(3, '0')} Terminal`;

        // ANSI color code regex
        const ansiRegex = /\033\[(\d+)m/g;
        const colorMap = {
            '37': 'ansi-white',
            '92': 'ansi-green',
            '91': 'ansi-red',
            '94': 'ansi-blue',
            '93': 'ansi-yellow',
            '96': 'ansi-cyan',
            '95': 'ansi-purple',
            '0': 'ansi-white'
        };

        function parseANSI(text) {
            let result = '';
            let lastIndex = 0;
            let currentClass = 'ansi-white';
            
            text.replace(ansiRegex, (match, code, index) => {
                if (index > lastIndex) {
                    result += `<span class="${currentClass}">${escapeHtml(text.substring(lastIndex, index))}</span>`;
                }
                currentClass = colorMap[code] || 'ansi-white';
                lastIndex = index + match.length;
                return '';
            });
            
            if (lastIndex < text.length) {
                result += `<span class="${currentClass}">${escapeHtml(text.substring(lastIndex))}</span>`;
            }
            
            return result || `<span class="${currentClass}">${escapeHtml(text)}</span>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function printToTerminal(terminal, text) {
            if (text === '[CLEAR]') {
                document.getElementById(`${terminal}-output`).innerHTML = '';
                return;
            }
            
            const output = document.getElementById(`${terminal}-output`);
            const line = document.createElement('div');
            line.innerHTML = parseANSI(text);
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function updateStatus(terminal, connected) {
            const indicator = document.getElementById(`${terminal}-status`);
            if (connected) {
                indicator.className = 'w-2 h-2 bg-emerald-500 rounded-full animate-pulse';
            } else {
                indicator.className = 'w-2 h-2 bg-red-500 rounded-full';
            }
        }

        function connectEngine() {
            const output = document.getElementById('engine-output');
            output.innerHTML = '<div class="text-neutral-500">Connecting to Engine...</div>';
            
            engineWs = new WebSocket(`ws://localhost:8083/${cpNum}`);
            
            engineWs.onopen = () => {
                updateStatus('engine', true);
                document.getElementById('engine-input').disabled = false;
                document.getElementById('engine-input').focus();
                document.getElementById('engine-container-name').textContent = `evcharging_cp_engine_${cpNum}`;
            };
            
            engineWs.onmessage = (event) => {
                printToTerminal('engine', event.data);
            };
            
            engineWs.onerror = (error) => {
                printToTerminal('engine', '\033[91m❌ WebSocket error. Is the bridge running?\033[0m');
                updateStatus('engine', false);
            };
            
            engineWs.onclose = () => {
                updateStatus('engine', false);
                document.getElementById('engine-input').disabled = true;
                printToTerminal('engine', '\033[93m⚠️ Connection lost. Reconnecting in 3 seconds...\033[0m');
                setTimeout(connectEngine, 3000);
            };
        }

        function connectMonitor() {
            const output = document.getElementById('monitor-output');
            output.innerHTML = '<div class="text-neutral-500">Connecting to Monitor...</div>';
            
            monitorWs = new WebSocket(`ws://localhost:8084/${cpNum}`);
            
            monitorWs.onopen = () => {
                updateStatus('monitor', true);
                document.getElementById('monitor-input').disabled = false;
                document.getElementById('monitor-container-name').textContent = `evcharging_cp_monitor_${cpNum}`;
            };
            
            monitorWs.onmessage = (event) => {
                printToTerminal('monitor', event.data);
            };
            
            monitorWs.onerror = (error) => {
                printToTerminal('monitor', '\033[91m❌ WebSocket error. Is the bridge running?\033[0m');
                updateStatus('monitor', false);
            };
            
            monitorWs.onclose = () => {
                updateStatus('monitor', false);
                document.getElementById('monitor-input').disabled = true;
                printToTerminal('monitor', '\033[93m⚠️ Connection lost. Reconnecting in 3 seconds...\033[0m');
                setTimeout(connectMonitor, 3000);
            };
        }

        function sendCommand(terminal, cmd) {
            const ws = terminal === 'engine' ? engineWs : monitorWs;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(cmd);
                document.getElementById(`${terminal}-input`).value = '';
            }
        }

        function handleInput(event, terminal) {
            if (event.key === 'Enter') {
                const input = document.getElementById(`${terminal}-input`);
                const command = input.value.trim();
                if (command) {
                    sendCommand(terminal, command);
                }
            }
        }

        function clearTerminal(terminal) {
            document.getElementById(`${terminal}-output`).innerHTML = '';
        }

        // Connect on load
        window.addEventListener('load', () => {
            connectEngine();
            connectMonitor();
        });
    </script>
</body>
</html>